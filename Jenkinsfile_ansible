pipeline {
    agent any
    environment {
        githosturl = "github.com"
    }
    
    stages { 
        stage('clone') {
            steps {
                git credentialsId: 'git_creds', url: 'https://github.com/hrudayhh/jjcfw.git'
            }
        }
        stage('pre-requisites') {
            steps {
                sh '''
                    echo "requirements file"
                    if [ -e roles/requirements.yml ]; then 
                      echo "req file found"
                    else
                      echo "req file not found"
                    fi
                '''
            }
        }
        stage('check urls') {
            steps {
                sh ''' 
                set -x
                ssh-keyscan ${githosturl} >> ~/.ssh/known_hosts
                cat ~/.ssh/known_hosts
                count_roles=$(grep "src" roles/requirements.yml | cut -d':' -f2,3 | awk '{$1=$1;print}' | wc -l)
                if [ "$count_roles" -eq 0 ]; then
                  echo "No roles defined in requirements.yml file"
                  exit 1
                elif [ "$count_roles" -gt 0 ]; then
                  echo "Roles are defined in requirements.yml file"
                  echo "Verfying URLs of roles"
                  for repo_url in $(grep "src" roles/requirements.yml | cut -d':' -f2,3 | awk '{$1=$1;print}')
                  do
                    git ls-remote $repo_url
                    if [ $? -ne 0 ]; then
                      echo "[ERROR] Git URL $repo_url not found"
                      exit 1
                    else
                      echo "Git URL $repo_url found"
                    fi
                   done
                fi
                '''
            }
        }
    }
}
